name: Test CMake Build Instructions

on:
  push:
    branches: [ main, cmake, develop ]
    paths:
      - '.github/copilot-instructions.md'
      - '.github/test-cmake-instructions.sh'
      - 'CMakeLists.txt'
      - 'cmake/**'
      - 'src/CMakeLists.txt'
  pull_request:
    branches: [ main, cmake, develop ]
    paths:
      - '.github/copilot-instructions.md'
      - '.github/test-cmake-instructions.sh'
      - 'CMakeLists.txt'
      - 'cmake/**'
      - 'src/CMakeLists.txt'
  workflow_dispatch:

jobs:
  test-instructions:
    name: Validate CMake Instructions
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            esmf_url: "https://example.com/esmf-linux.tar.gz"
            schism_url: "https://github.com/schism-dev/schism.git"
          - os: macos-latest
            esmf_url: "https://example.com/esmf-macos.tar.gz"
            schism_url: "https://github.com/schism-dev/schism.git"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gfortran \
            libopenmpi-dev \
            openmpi-bin \
            libnetcdf-dev \
            libnetcdff-dev \
            cmake

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gcc
          brew install open-mpi
          brew install netcdf
          brew install netcdf-fortran
          brew install cmake

      - name: Cache ESMF build
        id: cache-esmf
        uses: actions/cache@v3
        with:
          path: ~/esmf-install
          key: ${{ runner.os }}-esmf-8.4.0

      - name: Build ESMF (if not cached)
        if: steps.cache-esmf.outputs.cache-hit != 'true'
        run: |
          # This is a placeholder - in real CI, you'd either:
          # 1. Use pre-built ESMF from package manager
          # 2. Build ESMF from source
          # 3. Download pre-built artifacts
          echo "Building/installing ESMF..."
          mkdir -p ~/esmf-install/lib
          # Create a mock esmf.mk for testing
          cat > ~/esmf-install/lib/esmf.mk << 'EOF'
          ESMF_VERSION_MAJOR=8
          ESMF_VERSION_MINOR=4
          ESMF_VERSION_REVISION=0
          ESMF_VERSION_STRING=8.4.0
          ESMF_LIBSDIR=~/esmf-install/lib
          ESMF_F90COMPILER=gfortran
          EOF

      - name: Cache SCHISM build
        id: cache-schism
        uses: actions/cache@v3
        with:
          path: ~/schism-build
          key: ${{ runner.os }}-schism-master-${{ hashFiles('.github/workflows/test-cmake-build.yml') }}

      - name: Build SCHISM (if not cached)
        if: steps.cache-schism.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/schism-dev/schism.git ~/schism-src
          mkdir -p ~/schism-build
          cd ~/schism-build
          cmake ~/schism-src/src \
            -DCMAKE_Fortran_COMPILER=gfortran \
            -DOLDIO=ON \
            -DTVD_LIM=SB
          make -j$(nproc 2>/dev/null || sysctl -n hw.ncpu) || true
          # Create mock libraries if build fails (for testing the test framework)
          mkdir -p lib include
          touch lib/libhydro.a lib/libcore.a

      - name: Set environment variables
        run: |
          echo "ESMFMKFILE=$HOME/esmf-install/lib/esmf.mk" >> $GITHUB_ENV
          echo "SCHISM_BUILD_DIR=$HOME/schism-build" >> $GITHUB_ENV

      - name: Run test framework
        run: |
          chmod +x .github/test-cmake-instructions.sh
          .github/test-cmake-instructions.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.os }}
          path: |
            build-test-*/CMakeCache.txt
            build-test-*/CMakeFiles/CMakeError.log
            build-test-*/CMakeFiles/CMakeOutput.log

  test-documentation:
    name: Validate Instructions Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check copilot-instructions.md exists
        run: |
          if [ ! -f .github/copilot-instructions.md ]; then
            echo "Error: .github/copilot-instructions.md not found"
            exit 1
          fi

      - name: Validate markdown syntax
        uses: actionshub/markdownlint@main
        with:
          path: .github/copilot-instructions.md
          config: |
            {
              "MD013": false,
              "MD033": false
            }

      - name: Check for required sections
        run: |
          required_sections=(
            "Quick orientation"
            "Build and test commands"
            "CI-ready checklist"
            "Important patterns"
          )
          
          for section in "${required_sections[@]}"; do
            if ! grep -q "$section" .github/copilot-instructions.md; then
              echo "Error: Missing required section: $section"
              exit 1
            fi
          done
          echo "All required sections present"

      - name: Verify code blocks are valid
        run: |
          # Extract bash code blocks and check for syntax errors
          awk '/```bash/,/```/' .github/copilot-instructions.md | \
            grep -v '```' | \
            grep -v '^$' > /tmp/bash_snippets.sh || true
          
          if [ -s /tmp/bash_snippets.sh ]; then
            bash -n /tmp/bash_snippets.sh
            echo "Bash code blocks are syntactically valid"
          fi
